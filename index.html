<!doctype html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <link rel="stylesheet" href="css/style.css">

  <div class="row">
    <div class="col-xxl-8">
      <div class="card" id="map">
      </div>
    </div>
    <div class="col-xxl-4">
      <div class="card" id="chart"> 
      </div>
      <div class="card" id="description"> 
        <div class="card-header" id="stateName">
          State Name
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item" id="obesityRate">Obesity Rate</li>
          <li class="list-group-item" id="obesityPopulation">Obesity Population</li>
          <li class="list-group-item" style="font-size: 14px;">Number of Fast Food Restaurants</li>
        </ul>
      </div>
    </div>
  </div>
  <script>

    //map
    var height = 800;
    var width = 980;

    var projection = d3.geoAlbersUsa()
        .scale(1200)
        .translate([width/2, height/2.5]);
  
    var path = d3.geoPath().projection(projection);
    var svg1 = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height)

    Promise.all([d3.json('data/obesity.geojson'), d3.csv('data/FastFoodRestaurants.csv' )]).then(function ready(loadData) {

      var data = loadData[0]
      var points = loadData[1] 
      console.log(data)
      console.log(points)
      var minObesity = d3.min(data.features, function(e) {return e.properties.obesity});
      var maxObesity = d3.max(data.features, function(e) {return e.properties.obesity});
      console.log(minObesity)
      console.log(maxObesity)


      //chart
      var chartWidth = 480;
      var chartHeight = 400;
      var chart = d3.select("#chart").append("svg")
                    .attr('width', chartWidth).attr('height', chartHeight);
      
      var populationSorted = data.features.slice().sort(function(a,b){return d3.descending(+a.properties.population, +b.properties.population);})
      var obesitySorted = data.features.slice().sort(function(a,b){return d3.descending(+a.properties.obesity, +b.properties.obesity);})
      var obesityPopulationSorted = data.features.slice().sort(function(a,b){return d3.descending((+a.properties.obesity * 0.01 * a.properties.population), (+b.properties.obesity * 0.01 * b.properties.population));})
      var countryPopulationList = populationSorted.map(d => d.properties.name);
      var countryObesityList = obesitySorted.map(d => d.properties.name);
      var countryObesityPopulationList = obesityPopulationSorted.map(d => d.properties.name);
      var minPopulation = d3.min(data.features, function(e) {return e.properties.population});
      var maxPopulation = d3.max(data.features, function(e) {return e.properties.population});
      var xScale = d3.scaleLinear().domain([minPopulation, maxPopulation]).range([10, chartWidth]);
      var yScale = d3.scaleBand().domain(countryPopulationList).rangeRound([0, chartHeight]);
      var colorScale = d3.scaleLinear().domain([minPopulation, 2000000, 5000000, 9000000, maxPopulation]).range(["#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c"]);

      var getID = function(d) {
            return d.properties.name.replace(/\s+/g, '');
            };
      var clickChart = function(data) {
                  console.log(getID(data));
                  d3.selectAll("path").style('stroke', 'white').style('stroke-width', 1);
                  d3.select("#" + getID(data)).raise().style('stroke', '#2F4F4F').style('stroke-width', 2);
                  chart.selectAll("rect").attr('fill', function(d){return colorScale(d.properties.population);});
                  d3.select(this).attr("fill", "red");
                  d3.select("#population").text("Rank(" + (countryPopulationList.indexOf(data.properties.name) +1) + "): " + data.properties.population);
                  document.getElementById('stateName').innerHTML = data.properties.name + " State";
                  document.getElementById('obesityRate').innerHTML = "Obesity Rate: " + data.properties.obesity + "% (#" + (countryObesityList.indexOf(data.properties.name) +1) + ")";
                  document.getElementById('obesityPopulation').innerHTML = "Obesity Population: " + Math.trunc(data.properties.obesity * 0.01 * data.properties.population) + " (#" + (countryObesityPopulationList.indexOf(data.properties.name) +1) + ")";
                };

      chart.selectAll('.bar')
            .data(populationSorted)
            .enter().append('rect')
            .attr('class', 'bar')
            .attr('id', function(d) { return "b" + (d.properties.name).replace(/\s+/g, ''); })
            .attr('x', xScale(0))
            .attr('y', function(d, i) { return yScale(d.properties.name) + 0.5 * i -19; })
            .attr('width', function(d) { return xScale(d.properties.population); })
            .attr('height', yScale.bandwidth())
            .attr('fill', function(d){return colorScale(d.properties.population);})
            .on("click", clickChart);;

      chart.append("text")
          .attr("text-anchor", "end")
          .attr("x", 450 )
          .attr("y", 250)
          .text("Population")
          .style("font-size", 36)

      chart.append("text")
          .attr("text-anchor", "end")
          .attr("class", "rank")
          .attr("id", "population")
          .attr("x", 450 )
          .attr("y", 300)
          .text("")
          .style("font-size", 22)
      //map

      var clickMap = function(data) {
                  console.log(getID(data));
                  d3.selectAll("path").style('stroke', 'white').style('stroke-width', 1);
                  d3.select(this).raise().style('stroke', '#2F4F4F').style('stroke-width', 2);
                  chart.selectAll("rect").attr('fill', function(d){return colorScale(d.properties.population);});
                  d3.select("#b" + getID(data)).attr("fill", "red");
                  d3.select("#population").text("Rank(" + (countryPopulationList.indexOf(data.properties.name) +1) + "): " + data.properties.population);
                  document.getElementById('stateName').innerHTML = data.properties.name + " State";
                  document.getElementById('obesityRate').innerHTML = "Obesity Rate: " + data.properties.obesity + "% (#" + (countryObesityList.indexOf(data.properties.name) +1) + ")";
                  document.getElementById('obesityPopulation').innerHTML = "Obesity Population: " + Math.trunc(data.properties.obesity * 0.01 * data.properties.population) + " (#" + (countryObesityPopulationList.indexOf(data.properties.name) +1) + ")";
                };

      var color = d3.scaleLinear()
                .domain([minObesity, maxObesity])
                .range(["#ffeda0","#de2d26"]);

      var map = svg1.append('g')
          .attr('class', 'boundary')
          .selectAll("path")
          .data(data.features)
          .enter()
          .append("path")
          .attr('id', function(d) { return (d.properties.name).replace(/\s+/g, ''); })
          .attr("d", path)
          .style('stroke', 'white')
          .style('stroke-width', 1)
          .attr('fill', function(d){return color(d.properties.obesity);})
          .on("click", clickMap);

      //points
      svg1.append('g')
          .attr('class', 'boundary')
          .selectAll(".pin")
          .data(points)
          .enter().append("circle", ".pin")
          .attr("r", .55)
          .attr("fill", "#2F4F4F")
          .attr("transform", function(d) {
            if (projection([d.longitude,d.latitude]) !== null) {
              return "translate(" + projection([
                d.longitude,
                d.latitude
              ]) + ")";
            }
        });

      //legend
      svg1.append("g")
          .attr("class", "legend")
          .attr("transform", "translate(550,630)");

      var legendLinear = d3.legendColor()
          .shapeWidth(80)
          .orient('horizontal')
          .scale(color);

      svg1.select(".legend")
          .call(legendLinear);
      
      //text
      svg1.append("text")
          .attr("text-anchor", "end")
          .attr("x", 545 )
          .attr("y", 643)
          .text("Obesity Rate (%)");

      svg1.append("text")
          .attr("text-anchor", "end")
          .attr("x", 670 )
          .attr("y", 50)
          .text("Obesity Rate Across the United States")
          .style("font-size", 20);
      
      svg1.append("text")
          .attr("text-anchor", "end")
          .attr("x", 110 )
          .attr("y", 680)
          .text("Leo Fang")
          .style("font-size", 20);

      svg1.append("g")
          .attr("class", "pointLegend")
          .attr("transform", "translate(620,682)");

      svg1.select(".pointLegend")
          .append("circle", ".pin")
          .attr("r", 2)
          .attr("fill", "#2F4F4F");

      svg1.append("text")
          .attr("text-anchor", "end")
          .attr("x", 870 )
          .attr("y", 685)
          .text("is the location of one fast food restaurant")
          .style("font-size", 12);    

      //zoom
      var mapZoom = d3.zoom().scaleExtent([1, 3]).on("zoom", handleZoom);

      function handleZoom(e) {
        svg1.selectAll(".boundary").attr("transform", d3.event.transform)
      }

      d3.select("svg").call(mapZoom);
    }); 
  </script>
</body>
</html>
